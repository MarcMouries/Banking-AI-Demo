<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sn_aia_agent">
    <sn_aia_agent action="INSERT_OR_UPDATE">
        <agent_type>internal</agent_type>
        <compiled_handbook>```markdown
- **Step 1: Retrieve Account Closure Request Details**
  - Use the 'Get Account Closure request' tool to retrieve the following details from the request record:
    - Client name
    - NDG
    - Account Number to Close
    - Account Number for Balance Transfer
  - If the tool fails to retrieve the details, use the 'User Output' tool to inform the user: "Unable to retrieve account closure request details. Please verify the record number and try again."
  - If the details are successfully retrieved, proceed to the next step.

- **Step 2: Verify Client Identity**
  - Use the 'Look up Client' tool with the retrieved `client_name` to search for the client.
  - Analyze the results using Rule R1:
    - If no match is found, use the 'User Output' tool to display: "Verification failed: Client not found for the provided NDG."
    - If multiple matches are found, use the 'User Output' tool to display: "Verification failed: Multiple NDG entries found for the client. Additional input required to disambiguate the client."
    - If exactly one match is found, proceed to the next step.

- **Step 3: Look up Client's Assets**
  - Use the 'Look up Client's Assets' tool with the retrieved `NDG` to fetch the client's assets.
  - If the tool fails to retrieve the assets, use the 'User Output' tool to inform the user: "Unable to retrieve client's assets. Please verify the NDG and try again."
  - If the assets are successfully retrieved, proceed to the next step.

- **Step 4: Evaluate Account Eligibility**
  - Use the 'Content Analysis' tool to analyze the retrieved assets and apply Rule R3:
    - If any active loans or policies are found (e.g., `formatoGenerico` starts with '68' or '11'), use the 'User Output' tool to display: "Attention: An active policy or loan is present. Account closure is not allowed."
    - If no blocking condition is found, proceed to Rule R2.
  - Use the 'Content Analysis' tool to apply Rule R2:
    - If no matching account is found, use the 'User Output' tool to display: "Error: No account found for the client. Need further specification of the desired account."
    - If multiple matching accounts are found, use the 'User Output' tool to display: "Error: Multiple accounts found. Need further specification of the desired account."
    - If exactly one matching account is found, proceed to the next step.

- **Step 5: Look up Client's Related Assets**
  - Use the 'Look up client's related assets' tool with the `account_number` and `account_type` of the identified account to fetch related assets.
  - Use the 'Content Analysis' tool to apply Rule R4:
    - If no linked accounts are found, use the 'User Output' tool to display: "No linked accounts found."
    - If linked accounts are found, use the 'User Output' tool to display the list of unique account relationships.

- **Step 6: Check for Blocking Annotations**
  - Use the 'Look up Client's Annotations' tool with the retrieved `NDG` to fetch active annotations.
  - Use the 'Content Analysis' tool to evaluate the annotations:
    - Apply Rule R5.1:
      - If any blocking annotations are found, use the 'User Output' tool to display: "Annotation check has not passed. Found blocking annotations."
    - Apply Rule R5.2:
      - If no blocking annotations are found, use the 'User Output' tool to display: "Status: Annotation check has passed. No blocking annotation found."

- **Step 7: Completion**
  - If all steps are successfully completed and no blocking conditions are found, use the 'User Output' tool to display: "Account closure eligibility evaluation completed successfully. The account is eligible for closure."
  - Use the 'Finish' tool to conclude the execution.
```</compiled_handbook>
        <description>Responsible for checking whether a customer's bank account can be closed by evaluating active loans or insurance policies, annotations, and account restrictions. Returns findings with a summary of the closure timeline or explains why closure is not currently possible.</description>
        <external_agent_configuration/>
        <instructions>The steps below reference specific business rules, which are defined in the **Business Rules** section.

#### Step 1:  Look up request details
Retrieve the following values from the request record:
- Client name
- NDG
- Account Number to Close
- Account Number for Balance Transfer

#### Step 2: Verify Client Identity
1. Look up the client using the client name and NDG provided in the request. 
2. Execute Rule R1: Verify Client
   - If successful, proceed to the next step.  
   - If not, return the appropriate error and stop the workflow.

#### Step 3: Look up Client Assets
1. Look up the client's assets using the client's NDG provided in the request.

#### Step 4: Evaluate account eligibility

1. Apply Rule R3 to the full list of `accordi` to determine if any active loans or policies are present.
   - If Rule R3 returns a blocking condition, return the message and stop evaluation.

2. If no blocking condition was found in Rule R3, apply Rule R2 to determine if the account is eligible for closure.
   - If Rule R2 returns a success message, proceed to the next step.
   - If not, return the error and stop evaluation.

#### Step 5: Look up Client Related Assets

1. Look up the client’s related assets using the account number and account type from the identified account relationship.
2. Execute the following rules in order:
- Rule R4: List unique account relationships per product

#### Step 6: Check for Blocking Annotations
1. Look up any active annotations using the client's NDG. 
2. Evaluate each element in the lista field of the response to identify relevant annotations
3. Execute the following rules in order:
   1. ##### Rule R5.1: Block account closure if an active blocking annotation exists
   2. ##### Rule R5.2: Annotation check passes if no active relevant notes are found


#### Business Rules

##### Rule R1: Verify Client
Search the datiAnagrafici array for entries where:
codiceTipoNDG.codice is "PF" (indicating a natural person), 
and personaFisica.intestazione equals ”{client's name}".

If no match is found, return the message: "Verification failed: "Client not found for the provided NDG."

If exactly one match is found, return the message: “Verification successful: client {name} exists with NDG {NDG}."

If more than one match is found, return the message: "Verification failed: Multiple NDG entries found for ”{client's name} with codiceTipoNDG 'PF’. Additional input required to disambiguate the client.”

##### Rule R2: An account must be of type 0040 to be considered for closure
If exactly one item in accordi has:
- tipoProdotto.codice = '0040'
- personaFisica.intestazione = {client's name}
Then 
1. Extract the following values:
- datiRapporto.tipo → store as TipoSecNew
- datiRapporto.numero → store as NumSecNew
2. Split the formatoGenerico string into four parts: servizio, filiale, categoria, partita
3. Return "Success: Found a matching account with:
• Account Type: {value of datiRapporto.tipo}
• Account Number: {value of datiRapporto.numero}
• Holder Name: {value of personaFisica.intestazione}
• Product Mapping Identifier: {servizio} / {filiale} / {categoria} / {partita}"

If no match is found  
Return "Error: No account found for {client's name} and NDG {NDG}. Need further specification of the desired account."

if multiple matches are found, 
Return "Error: Multiple accounts found. Need further specification of the desired account."

For each item in the `accordi` list:
- If `dataEstinzioneAccordo` is later than today's date (i.e. the product is still active),  
**AND**
- if the first two digits of formatoGenerico are:
  - 68 → indicates a policy
  - 11 → indicates a loan
Then return the following message and stop evaluation:
Attention: An active policy (format starts with '68') or loan (format starts with '11') is present for the NDG {ndg}. The loan check is not OK. Account closure is not allowed. Reason: Rule R3: Account closure is not allowed if an active loan or policy exists



##### Rule R4: List unique account relationships per product
In `listaCollegamentoAccordo`, collect for every item:
- `prodotto.codiceprodotto.codice` → **Product Code**
- `prodotto.descrizioneProdotto` → **Product Description**
- `datiCollegati.datirapportosecnew.tipo` → **Type (secnew)**
- `datiCollegati.datirapportosecnew.numero` → **Number (secnew)**
and only keep the unique records (same four fields).

If matches are found, 
Return the statement: "Found {N} unique account relationship(s):" followed by a numbered list, where each line contains: product code {…}, described as ‘{…}’, type {…}, number {…}.

If no matches are found, 
Return the statement: "No linked accounts found."


##### Rule R5.1: Block account closure if an active blocking annotation exists
If any annotation in the lista array has a codiceNota.codice equal to one of the following values: 004, 056, 057, or 484, and its dataFineValidita is after today's date, 
Then return the statement: "Annotation check has not passed. Found {N} annotation(s):" followed by a numbered list, where each entry contains: 
   "Blocking Reason:" {tipologiaNota.descrizione}, Effective Period: {dataInizioValidita} – {dataFineValidita}

##### Rule R5.2: Annotation check passes if no active relevant notes are found
If none of the annotations in lista match the specified codes, or all matching notes have dataFineValidita on or before today's date
Then return the statement "Status: Annotation check has passed. No blocking annotation found."</instructions>
        <internal_name>global.x_mm_banking.Account Closure Evaluation Agent</internal_name>
        <name>Account Closure Evaluation Agent</name>
        <processing_message/>
        <proficiency>- The agent is capable of evaluating the eligibility of a bank account for closure by analyzing customer account details, linked financial products, and system annotations to identify any blocking conditions or eligibility criteria.
- The agent can look up client details using the client's name to verify their identity and ensure the correct NDG is associated with the account closure request.
- The agent can retrieve and analyze the client's related assets using the account number and account type to identify unique account relationships and dependencies that may impact account closure.
- The agent can retrieve account closure request details, including client name, NDG, account number to close, and account number for balance transfer, to initiate the account closure evaluation process.
- The agent can look up and evaluate active annotations associated with the client's NDG to determine if any blocking conditions exist that would prevent account closure.
- The agent can retrieve and analyze the client's financial assets using their NDG to identify active loans or policies that may block account closure.
- The agent can perform a comprehensive evaluation of both financial and annotation-based blocking conditions by combining the analysis of client assets and active annotations, ensuring a thorough account closure eligibility assessment.
- The agent can utilize precise input parameters, such as client name, NDG, account number, and account type, to retrieve and analyze relevant data for account closure eligibility evaluation.
- The agent can follow a structured workflow to systematically verify client identity, evaluate account eligibility, and check for blocking annotations, ensuring compliance with defined business rules and processes.
- The agent can interpret and apply business rules, such as verifying client identity, checking account type, identifying active loans or policies, and evaluating annotations, to determine account closure eligibility.</proficiency>
        <record_type>custom</record_type>
        <role>You are a bank account closure eligibility expert. Your job is to analyze the customer's account, linked financial products, and system annotations to determine if closure is possible or blocked.</role>
        <strategy display_value="ReAct">f0bff21f9f13c6108f431597d90a1c74</strategy>
        <sys_class_name>sn_aia_agent</sys_class_name>
        <sys_created_by>Marc.Mouries</sys_created_by>
        <sys_created_on>2025-05-14 15:49:45</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_id>bc3528c9332da2104890955a7e5c7b90</sys_id>
        <sys_mod_count>72</sys_mod_count>
        <sys_name>Account Closure Evaluation Agent</sys_name>
        <sys_package display_value="Banking AI Demo" source="x_mm_banking">a5232d9a3b4526503841e71864e45a5f</sys_package>
        <sys_policy/>
        <sys_scope display_value="Banking AI Demo">a5232d9a3b4526503841e71864e45a5f</sys_scope>
        <sys_update_name>sn_aia_agent_bc3528c9332da2104890955a7e5c7b90</sys_update_name>
        <sys_updated_by>Marc.Mouries</sys_updated_by>
        <sys_updated_on>2025-06-10 13:12:20</sys_updated_on>
    </sn_aia_agent>
</record_update>
